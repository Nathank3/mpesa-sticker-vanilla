<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M-Pesa Sticker Utility</title>
  <style>
    :root{
      --mpesa-green:#21c25e; /* closer to Safaricom green */
      --border:#0a0a0a;
      --muted:#374151;
      --bg:#f5f7fb;
    }
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#111827}
    .container{display:grid;grid-template-columns:1fr;gap:20px;padding:24px;max-width:1200px;margin:0 auto}
    @media(min-width:992px){.container{grid-template-columns:380px 1fr}}

    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.06);padding:16px}
    h1{margin:0 0 6px;font-weight:900;letter-spacing:-.02em}
    .sub{color:#6b7280;margin-bottom:12px}

    .row{display:flex;gap:8px}
    .btn{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#f3f4f6;font-weight:800;cursor:pointer}
    .btn.active{background:#0f172a;color:#fff}
    .btn.g.active{background:#10b981;border-color:#10b981;color:#fff}
    label{display:block;font-size:13px;font-weight:800;margin:10px 0 6px}
    input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:15px}

    .export{display:flex;gap:10px;margin-top:10px}
    .export .btn{flex:1}
    .export .png{background:#10b981;color:#fff;border-color:#10b981}
    .export .pdf{background:#0f172a;color:#fff;border-color:#0f172a}

    /* Sticker */
    .sticker{width:920px;max-width:100%;border:3px solid var(--border);border-radius:6px;background:#fff;display:flex;flex-direction:column}
    .top{background:var(--mpesa-green);color:#fff;font-weight:900;text-transform:uppercase;text-align:center;padding:14px 16px;font-size:30px;letter-spacing:.04em}
    .mid{padding:12px 16px;text-align:center;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.06em}
    .boxes-wrap{padding:12px 24px}
    .boxes{--count:10;display:grid;grid-template-columns:repeat(var(--count),1fr);gap:12px;align-items:center}
    .box{height:72px;background:#fff;border:3px solid var(--border);border-radius:4px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;letter-spacing:.06em}
    .name-wrap{padding:6px 24px 20px}
    .name-field{border:3px solid var(--border);border-radius:4px;height:48px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:20px}
  </style>
  <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h1 style="padding:24px; padding-bottom:0;">M-Pesa Sticker Utility</h1>
  <div class="sub" style="padding:0 24px 8px;">Type your details, see a live sticker, then download as PNG or A6 PDF. Pure HTML/CSS/JS.</div>
  <div class="container">
    <div class="card">
      <div class="row">
        <button id="mode-send" class="btn active" type="button">Send Money</button>
        <button id="mode-lipa" class="btn" type="button">Lipa na M-PESA</button>
      </div>
      <div id="lipa-types" style="display:none;margin-top:8px">
        <div class="row">
          <button id="type-till" class="btn g active" type="button">Till</button>
          <button id="type-paybill" class="btn g" type="button">Paybill</button>
          <button id="type-pochi" class="btn g" type="button">Pochi</button>
        </div>
      </div>

      <div id="inputs-send">
        <label>Phone Number</label>
        <input id="in-phone" type="tel" placeholder="07XXXXXXXX">
        <label>Name</label>
        <input id="in-name-send" type="text" placeholder="e.g., Marie Muchiri">
      </div>

      <div id="inputs-till" style="display:none">
        <label>Till Number</label>
        <input id="in-till" type="tel" placeholder="e.g., 123456">
        <label>Name</label>
        <input id="in-name-till" type="text" placeholder="Business name">
      </div>

      <div id="inputs-paybill" style="display:none">
        <label>Paybill Number</label>
        <input id="in-paybill" type="tel" placeholder="e.g., 247247">
        <label>Account Number</label>
        <input id="in-account" type="text" placeholder="Meter / Student ID / Ref">
        <label>Name</label>
        <input id="in-name-paybill" type="text" placeholder="Business name">
      </div>

      <div id="inputs-pochi" style="display:none">
        <label>Phone Number (Pochi)</label>
        <input id="in-pochi" type="tel" placeholder="07XXXXXXXX">
        <label>Name</label>
        <input id="in-name-pochi" type="text" placeholder="e.g., Mama Mboga">
      </div>

      <div class="export">
        <button id="btn-png" class="btn png" type="button">Download PNG</button>
        <button id="btn-pdf" class="btn pdf" type="button">Download PDF (A6)</button>
      </div>
    </div>

    <div class="card">
      <div class="sticker" id="sticker">
        <div class="top" id="top">SEND MONEY</div>
        <div class="mid" id="mid">SEND MONEY</div>
        <div class="boxes-wrap"><div class="boxes" id="primary"></div></div>
        <div class="name-wrap"><div class="name-field" id="nameField"></div></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // state
    let mode = 'send'; // send | lipa
    let lipaType = 'till'; // till | paybill | pochi

    let phone='', nameSend='';
    let till='', nameTill='';
    let paybill='', account='', namePaybill='';
    let pochi='', namePochi='';

    // els
    const modeSend = $('mode-send'); const modeLipa = $('mode-lipa');
    const typesWrap = $('lipa-types');
    const typeTill = $('type-till'); const typePaybill = $('type-paybill'); const typePochi = $('type-pochi');

    const inPhone=$('in-phone'), inNameSend=$('in-name-send');
    const inTill=$('in-till'), inNameTill=$('in-name-till');
    const inPaybill=$('in-paybill'), inAccount=$('in-account'), inNamePaybill=$('in-name-paybill');
    const inPochi=$('in-pochi'), inNamePochi=$('in-name-pochi');

    const topBar=$('top'), midLbl=$('mid'), primary=$('primary'), nameField=$('nameField');

    function digitsOnly(v,max){ return (v||'').replace(/\D+/g,'').slice(0,max); }

    function renderBoxes(val, fixedCount){
      const digits=(val||'').replace(/\D+/g,'');
      const count = fixedCount ?? Math.max(1, digits.length || 1);
      primary.innerHTML='';
      primary.style.setProperty('--count', count);
      for(let i=0;i<count;i++){
        const d=document.createElement('div');
        d.className='box';
        d.textContent=digits[i]||'';
        primary.appendChild(d);
      }
    }

    function update(){
      const isSend = mode==='send';
      const isPochi = lipaType==='pochi';

      modeSend.classList.toggle('active', isSend);
      modeLipa.classList.toggle('active', !isSend);
      typesWrap.style.display = isSend ? 'none' : 'block';

      $('inputs-send').style.display = isSend ? 'block' : 'none';
      $('inputs-till').style.display = (!isSend && lipaType==='till') ? 'block' : 'none';
      $('inputs-paybill').style.display = (!isSend && lipaType==='paybill') ? 'block' : 'none';
      $('inputs-pochi').style.display = (!isSend && lipaType==='pochi') ? 'block' : 'none';

      typeTill.classList.toggle('active', lipaType==='till');
      typePaybill.classList.toggle('active', lipaType==='paybill');
      typePochi.classList.toggle('active', lipaType==='pochi');

      topBar.textContent = isSend ? 'SEND MONEY' : 'LIPA NA M-PESA';
      if(isSend) midLbl.textContent = 'SEND MONEY';
      else if(lipaType==='till') midLbl.textContent = 'BUY GOODS TILL NUMBER';
      else if(lipaType==='paybill') midLbl.textContent = 'PAYBILL';
      else if(lipaType==='pochi') midLbl.textContent = 'POCHI LA BIASHARA';

      let primaryVal='';
      if(isSend || isPochi) primaryVal = isPochi ? pochi : phone;
      else primaryVal = lipaType==='till' ? till : paybill;

      renderBoxes(primaryVal, (isSend||isPochi)?10:undefined);

      const nm = isSend ? nameSend : (lipaType==='till'?nameTill : lipaType==='paybill'?namePaybill : namePochi);
      nameField.textContent = nm||'';
    }

    modeSend.onclick=()=>{ mode='send'; update(); };
    modeLipa.onclick=()=>{ mode='lipa'; update(); };
    typeTill.onclick=()=>{ lipaType='till'; update(); };
    typePaybill.onclick=()=>{ lipaType='paybill'; update(); };
    typePochi.onclick=()=>{ lipaType='pochi'; update(); };

    inPhone.oninput=(e)=>{ phone=digitsOnly(e.target.value,10); e.target.value=phone; update(); };
    inNameSend.oninput=(e)=>{ nameSend=e.target.value; update(); };
    inTill.oninput=(e)=>{ till=digitsOnly(e.target.value,12); e.target.value=till; update(); };
    inNameTill.oninput=(e)=>{ nameTill=e.target.value; update(); };
    inPaybill.oninput=(e)=>{ paybill=digitsOnly(e.target.value,12); e.target.value=paybill; update(); };
    inAccount.oninput=(e)=>{ /* account text not shown on sticker to match image, keep for later */ };
    inNamePaybill.oninput=(e)=>{ namePaybill=e.target.value; update(); };
    inPochi.oninput=(e)=>{ pochi=digitsOnly(e.target.value,10); e.target.value=pochi; update(); };
    inNamePochi.oninput=(e)=>{ namePochi=e.target.value; update(); };

    async function getDataUrl(){
      const node = document.getElementById('sticker');
      return await htmlToImage.toPng(node, {pixelRatio:2, cacheBust:true, backgroundColor:'#ffffff'});
    }

    function safeDownload(url, filename){
      const a=document.createElement('a');
      a.href=url; a.download=filename; a.rel='noopener'; a.target='_blank';
      document.body.appendChild(a); a.click(); a.remove();
    }

    document.getElementById('btn-png').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{ const dataUrl = await getDataUrl(); safeDownload(dataUrl,'mpesa-sticker.png'); }
      catch(err){ console.error(err); alert('PNG export failed. Try a different browser/network (CDNs may be blocked).'); }
    });

    document.getElementById('btn-pdf').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        const dataUrl = await getDataUrl();
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({orientation:'landscape', unit:'mm', format:'a6'});
        const imgProps = pdf.getImageProperties(dataUrl);
        const pw = pdf.internal.pageSize.getWidth();
        const ph = pdf.internal.pageSize.getHeight();
        const r = Math.min(pw/imgProps.width, ph/imgProps.height);
        const w = imgProps.width*r, h = imgProps.height*r;
        const x=(pw-w)/2, y=(ph-h)/2;
        pdf.addImage(dataUrl,'PNG',x,y,w,h);
        pdf.save('mpesa-sticker.pdf');
      }catch(err){ console.error(err); alert('PDF export failed. Try a different browser/network.'); }
    });

    update();
  </script>
</body>
</html>


